---
title: "golangè¿›é˜¶â€”channelã€select"
date: "2025-02-03"
lastmod: "2025-10-06T17:16:00.000Z"
draft: false
featuredImage: "https://whitea.dpdns.org/api?page_id=28493dc3-968c-80a1-923c-e4cc5fbba0e3"
series: []
authors:
  - "Whitea"
tags:
  - "Golang"
categories:
  - "æŠ€æœ¯"
Last edited time: "2025-02-03"
NOTION_METADATA:
  object: "page"
  id: "28493dc3-968c-80a1-923c-e4cc5fbba0e3"
  created_time: "2025-10-06T07:45:00.000Z"
  last_edited_time: "2025-10-06T17:16:00.000Z"
  created_by:
    object: "user"
    id: "102d872b-594c-81b1-ab63-0002c10e95af"
  last_edited_by:
    object: "user"
    id: "102d872b-594c-81b1-ab63-0002c10e95af"
  cover:
    type: "file"
    file:
      url: "https://prod-files-secure.s3.us-west-2.amazonaws.com/521e321f-c2b1-43d8-8\
        420-f4e705febb38/de6a92cb-de65-4059-95df-b342bfc2d402/1.png?X-Amz-Algor\
        ithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Crede\
        ntial=ASIAZI2LB466VBIXADER%2F20251006%2Fus-west-2%2Fs3%2Faws4_request&X\
        -Amz-Date=20251006T171717Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJ\
        b3JpZ2luX2VjEPj%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIEJ\
        kHHS29OLNHqvHD74z545SkK%2BS1gZTNxRG3koGEy6KAiEAhAr49y%2F5VzzkWF7zPG3G91\
        9gJxGQfSFnX0vZHM%2FT7KkqiAQIkf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc\
        0MjMxODM4MDUiDLWsz1bVvNd0pVXUMCrcA4SryB1PZgAujmqorkgWG07bGCD3BG%2BTf1ZS\
        zdVeTI96y3RSn2J60mTuVkObN80G7Xhg2rQsGWPwpnDYD7T5al0XDjaa%2FCQ4%2Brw4uHq\
        RU95akRanJYBE31GtqE5dFZXTIaj8%2BLc7rnB90NDBeAanjPgcy1XOe4MKerSE%2BeTG9C\
        jLYo92DYQSe1KV2GX4tyxLWnfhFM%2FJ5nGg%2FF8EKMmfsgkK%2BbWEULoGeSdWWPTguXc\
        YacQLbgXk0b908GNIJcvOssNCdEEuQSO3T%2FFKhlTBJWr7NdUnbu9NhAO22SlU6SncmD0K\
        KCEMaKQ5my9nVn4RYTzqzrxrgQXlOoLR%2FkksXeDjJWA8r9JJGVU%2FFy3RVji3WSmvjVV\
        P3Yc3GvAC%2FfcKicZv7UheeOEr6DQOTE02VsJg6EJ5atoCTx1YIsWONXNcpy1wNrStL8rR\
        Q8ZboItF8b0Gl0NwTd5MzK59KLYWQXW%2FmIvvm6kMJsYLZyTAw4IxmiMVWya6s%2FzLIJI\
        kChY%2FoQKpYXHiZ9KPf%2F0EWnBrqoJ1g5YPCPtjvYNHZ1DUb1VdUaUDmHR0tsqBKaoIKD\
        r9QUsmtK83n3ooamFKM3ycrXcV4g%2FneP%2BxirfnMd43HInYk60%2BiZhIn8phhsCNMPT\
        Jj8cGOqUBxt5WAvEdeYVFwXQ7nkMCm5SPNLs1rdUzJZQzHY%2BslkEcl1t0u4E4DhEV8h3Y\
        SJ81IOmEt8uURjrVUpXTCc58X%2BippvNzkU3%2BBeP6ScHSLPDNscLHFPpB4ILgLRrUpn1\
        4MMxAFzjIq5ukX7EKiK7Odmvb01NmU3b96krfcR22wqE3U9S167Ra94702y12rBlW6Nbj8Q\
        1lJVwErldnasAntM60a4pj&X-Amz-Signature=063aafa343720f4b49202623c544cb0d\
        8ba4a0fbedf3f2148f0ab2355fe8d14d&X-Amz-SignedHeaders=host&x-amz-checksu\
        m-mode=ENABLED&x-id=GetObject"
      expiry_time: "2025-10-06T18:17:17.196Z"
  icon: null
  parent:
    type: "database_id"
    database_id: "28393dc3-968c-8157-9edc-c528b069ca6f"
  archived: false
  in_trash: false
  is_locked: false
  properties:
    series:
      id: "B%3C%3FS"
      type: "multi_select"
      multi_select: []
    date:
      id: "C%3CqD"
      type: "date"
      date:
        start: "2025-02-03"
        end: null
        time_zone: null
    draft:
      id: "JiWU"
      type: "checkbox"
      checkbox: false
    authors:
      id: "bK%3B%5B"
      type: "people"
      people:
        - object: "user"
          id: "102d872b-594c-81b1-ab63-0002c10e95af"
          name: "Whitea"
          avatar_url: "https://s3-us-west-2.amazonaws.com/public.notion-static.com/529138\
            7a-5664-4f8d-a6b4-c9f1e5bc89da/avater.png"
          type: "person"
          person:
            email: "whitea0029@gmail.com"
    custom-front-matter:
      id: "c~kA"
      type: "rich_text"
      rich_text: []
    tags:
      id: "jw%7CC"
      type: "multi_select"
      multi_select:
        - id: "070ece14-5231-4d92-b2ca-462de13ca245"
          name: "Golang"
          color: "gray"
    categories:
      id: "nbY%3F"
      type: "multi_select"
      multi_select:
        - id: "2df927de-e471-4f86-9001-37b594f12911"
          name: "æŠ€æœ¯"
          color: "gray"
    Last edited time:
      id: "vbGE"
      type: "date"
      date:
        start: "2025-02-03"
        end: null
        time_zone: null
    summary:
      id: "x%3AlD"
      type: "rich_text"
      rich_text: []
    Name:
      id: "title"
      type: "title"
      title:
        - type: "text"
          text:
            content: "golangè¿›é˜¶â€”channelã€select"
            link: null
          annotations:
            bold: false
            italic: false
            strikethrough: false
            underline: false
            code: false
            color: "default"
          plain_text: "golangè¿›é˜¶â€”channelã€select"
          href: null
  url: "https://www.notion.so/golang-channel-select-28493dc3968c80a1923ce4cc5fbba\
    0e3"
  public_url: null
MANAGED_BY_NOTION_HUGO: true

---


åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ•°æ®ç»“æ„channelå’Œselectè¯­å¥è¢«é«˜é¢‘ä½¿ç”¨ï¼Œæœ¬æ–‡åŸºäºGo1.18.1ç‰ˆæœ¬çš„æºç ï¼Œæ¢è®¨channelçš„åº•å±‚æ•°æ®ç»“æ„å’Œselectè®¿é—®Channelåœ¨ç¼–è¯‘æœŸå’Œè¿è¡Œæ—¶çš„åº•å±‚åŸç†


æ¢è®¨åº•å±‚åŸç†æ˜¯ä¸€ä¸ªå¾ˆå¥‡å¦™å´æ¯ç‡¥ä¹å‘³çš„è¿‡ç¨‹ï¼Œå¸Œæœ›è¯»è€…æ‚¨èƒ½ä¿æŒè¶³å¤Ÿçš„è€å¿ƒï¼Œæˆ‘ä»¬å¼€å§‹å§ğŸ¤—


## channel çš„åº•å±‚æ•°æ®ç»“æ„


```go
ch := make(chan int, 5)
```


æˆ‘ä»¬é€šè¿‡`make`å…³é”®å­—åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºä¸º`5`å­˜å‚¨æ•°æ®ç±»å‹ä¸º`int`çš„`channel`ï¼Œchå­˜å‚¨åœ¨æ ˆä¸Šçš„ä¸€ä¸ªæŒ‡é’ˆï¼Œè€ŒæŒ‡å‘çš„æ˜¯å †ä¸Šçš„`hchan`ç»“æ„ä½“


[](28493dc3-968c-8048-9bc8-e7247a13fc95)


é¦–å…ˆä¸€ä¸ª`channel`éœ€è¦èƒ½æ”¯æŒå¤šä¸ª`goroutine`å¹¶å‘è®¿é—®ï¼Œè¿™éœ€è¦ä¸€æŠŠğŸ”’(`lock mutex`)


å¯¹äºæœ‰ç¼“å†²åŒºçš„`channel`è€Œè¨€ï¼Œéœ€è¦çŸ¥é“ç¼“å†²åŒºçš„ä½ç½®(`buf unsafe.Pointer`)ä»¥åŠç¼“å†²åŒºå†…æœ‰å¤šå°‘ä¸ªå…ƒç´ (`qcount unit`)ï¼Œæ¯ä¸ªå…ƒç´ å¤šå¤§(`datasiz uint`)ï¼Œæ‰€ä»¥ç¼“å†²åŒºå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„


å› ä¸ºgolangè¿è¡Œæ—¶ä¸­å†…å­˜å¤åˆ¶ã€åƒåœ¾å›æ”¶ç­‰æœºåˆ¶ä¾èµ–æ•°æ®çš„ç±»å‹ä¿¡æ¯ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªæŒ‡é’ˆ(`elemtype *_type`)æŒ‡å‘æ•°æ®çš„ç±»å‹å…ƒæ•°æ®


ä¸ºäº†æ”¯æŒå®šæ—¶å™¨çš„åŠŸèƒ½æ·»åŠ äº†`timer *timer`


`channel`æ”¯æŒäº¤æ›¿çš„è¯»å†™ï¼Œéœ€è¦åˆ†åˆ«è®°å½•è¯»å’Œå†™ä¸‹æ ‡çš„ä½ç½®(`sendx uint recvx uint`)ï¼Œå½“è¯»å’Œå†™ä¸èƒ½ç«‹å³å®Œæˆçš„æ—¶å€™ï¼Œéœ€è¦èƒ½å¤Ÿè®©å½“å‰çš„`goroutine`åœ¨`channel`ä¸Šç­‰å¾…ï¼Œå½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œéœ€è¦å¯ä»¥ç«‹å³å”¤é†’ç­‰å¾…ä¸­çš„`goroutine`ï¼Œæ‰€æœ‰éœ€è¦ä¸¤ä¸ªç­‰å¾…é˜Ÿåˆ—æ¥é’ˆå¯¹è¯»å’Œå†™æ“ä½œ(`sendq waitq recvq waitq`)


`channel`æ”¯æŒè¢«å…³é—­(`closed uint32`)


ç»¼ä¸Šæ‰€è¿°ï¼Œ`channel`çš„åº•å±‚æ•°æ®ç»“æ„å°±é•¿è¿™ä¸ªæ ·å­


```go
type hchan struct {
	qcount   uint           // total data in the queue
	dataqsiz uint           // size of the circular queue
	buf      unsafe.Pointer // points to an array of dataqsiz elements
	elemsize uint16
	closed   uint32
	timer    *timer // timer feeding this chan
	elemtype *_type // element type
	sendx    uint   // send index
	recvx    uint   // receive index
	recvq    waitq  // list of recv waiters
	sendq    waitq  // list of send waiters

	// lock protects all fields in hchan, as well as several
	// fields in sudogs blocked on this channel.
	//
	// Do not change another G's status while holding this lock
	// (in particular, do not ready a G), as this can deadlock
	// with stack shrinking.
	lock mutex
}
```


å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ‰ç¼“å†²åŒºçš„`channel`çš„æ—¶å€™ï¼Œ`recvx`å’Œ`sendx`éƒ½ä¸º0,ä¸æ–­å¾€`channel`ä¸­å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå› ä¸ºæ²¡æœ‰`goroutine`åœ¨ç­‰å¾…æ¥æ”¶æˆ–å‘é€æ•°æ®ï¼Œæ‰€ä»¥`send`ä¼šä¸æ–­å‘åç§»åŠ¨ï¼Œæœ€åç§»åŠ¨å›èµ·ç‚¹(`recvx = sendx`)ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™åˆ™è¡¨æ˜`channel`çš„ç¼“å†²åŒºæ»¡äº†ï¼Œå…¶å®`channel`çš„ç¼“å†²åŒºæ˜¯ä¸€ä¸ª**ç¯å½¢é˜Ÿåˆ—**ï¼Œä¹Ÿç§°ä¹‹ä¸º**ç¯å½¢ç¼“å†²åŒº**


é‚£å¦‚æœå½“ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œ`goroutine`è¿˜æƒ³å¾€`channel`ä¸­å‘é€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™`goroutine`å°±ä¼šè¿›å…¥åˆ°å‘é€ç­‰å¾…é˜Ÿåˆ—`sendq`ï¼ˆè¿™æ˜¯ä¸€ä¸ª`sudog`ç±»å‹çš„é“¾è¡¨ï¼‰ï¼Œ`sudog`ä¸­çš„`g *g`å°±è®°å½•è¯¥`goroutine`çš„ä¿¡æ¯ï¼Œ`*hchan`è®°å½•ç€åœ¨ç­‰å¾…å“ªä¸ª`channel`ï¼Œ`elem unsafe.Pointer`å­˜å‚¨ç€æ•°æ®æŒ‡é’ˆã€‚ä¸‹é¢æ˜¯æˆªå–çš„æºç æ³¨é‡Š


```go
type waitq struct {
	first *sudog
	last  *sudog
}

type sudog struct {
	// The following fields are protected by the hchan.lock of the
	// channel this sudog is blocking on. shrinkstack depends on
	// this for sudogs involved in channel ops.

	g *g

	next *sudog
	prev *sudog
	elem unsafe.Pointer // data element (may point to stack)

	// The following fields are never accessed concurrently.
	// For channels, waitlink is only accessed by g.
	// For semaphores, all fields (including the ones above)
	// are only accessed when holding a semaRoot lock.

	acquiretime int64
	releasetime int64
	ticket      uint32

	// isSelect indicates g is participating in a select, so
	// g.selectDone must be CAS'd to win the wake-up race.
	isSelect bool

	// success indicates whether communication over channel c
	// succeeded. It is true if the goroutine was awoken because a
	// value was delivered over channel c, and false if awoken
	// because c was closed.
	success bool

	// waiters is a count of semaRoot waiting list other than head of list,
	// clamped to a uint16 to fit in unused space.
	// Only meaningful at the head of the list.
	// (If we wanted to be overly clever, we could store a high 16 bits
	// in the second entry in the list.)
	waiters uint16

	parent   *sudog // semaRoot binary tree
	waitlink *sudog // g.waiting list or semaRoot
	waittail *sudog // semaRoot
	c        *hchan // channel
}

```


æ˜¾ç„¶ï¼Œå½“å¦å¤–ä¸€ä¸ª`goroutine`è¿›æ¥è¯»å–`channel`çš„æ•°æ®ï¼Œ`recvx`å‘åç§»åŠ¨ï¼Œç¼“å†²åŒºåˆæœ‰äº†ç©ºé—´ï¼Œè¿™æ—¶ä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„`goroutine`ï¼Œè®©å…¶æ‰§è¡Œå†™å…¥æ•°æ®çš„æ“ä½œ


åˆ°è¿™é‡Œæˆ‘ä»¬å°±è®¤è¯†åˆ°äº†`channel`åº•å±‚çš„æ•°æ®ç»“æ„


## å‘é€æ•°æ®åˆ°channel


å½“`channel`çš„ç¼“å†²åŒºæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰æ˜¯ä¸é˜»å¡çš„ï¼š

- ç¼“å†²åŒºè¿˜æœ‰ç©ºé—²ä½ç½®
- æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—ä¸­è¿˜æœ‰é˜»å¡ç­‰å¾…çš„`goroutine`

![](https://whitea.dpdns.org/api?block_id=28493dc3-968c-80af-a425-c74cf405ee41)


ç›¸åï¼Œé˜»å¡çš„æ¡ä»¶åˆ™æ˜¯ï¼š

- `channel`ä¸º`nil`
- `channel`æ— ç¼“å†²åŒºä¸”æ¥æ”¶é˜Ÿåˆ—ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…çš„`goroutine`
- ç¼“å†²åŒºæ»¡äº†ä¸”æ¥æ”¶é˜Ÿåˆ—ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…çš„`goroutine`

å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´å†™ä»£ç çš„æ–¹å¼å°½é‡ä¸é˜»å¡


å…è®¸é˜»å¡å¼ä»£ç ï¼š


```go
ch <- 10

```


éé˜»å¡å¼ä»£ç ï¼š


```go
select {
case ch <- 10:
    ...
default:
    ...
}

```


å¦‚æœä¸Šé¢çš„`case`é˜»å¡äº†ï¼Œå°±ä¼šè¿›å…¥åˆ°`default`åˆ†æ”¯å½“ä¸­


è¿™æ˜¯å‘é€æ•°æ®çš„å†™æ³•ï¼Œæ¥æ”¶æ•°æ®çš„å†™æ³•ä¼šæ›´å¤šä¸€ç‚¹


## ä»channelä¸­æ¥æ”¶æ•°æ®


ä»`channel`ä¸­æ¥æ”¶æ•°æ®ä¸é˜»å¡ï¼š

- ç¼“å†²åŒºå­˜åœ¨æ•°æ®
- æ²¡æœ‰ç¼“å†²åŒºä½†æ˜¯`sendq`ä¸­æœ‰é˜»å¡ç­‰å¾…å‘é€çš„`goroutine`

ç›¸åï¼Œé˜»å¡çš„æƒ…å†µä¸ºï¼š

- `channel`ä¸º`nil`
- æ²¡æœ‰ç¼“å†²åŒºä¸”`sendq`ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…å‘é€çš„`goroutine`
- ç¼“å†²åŒºä¸ºç©ºä¸”`sendq`ä¸­æ²¡æœ‰é˜»å¡ç­‰å¾…å‘é€çš„`goroutine`

å…è®¸é˜»å¡å¼ä»£ç ï¼š


```go
// ä¸¢å¼ƒchä¸­æ¥æ”¶çš„æ•°æ®
<-ch

// å°†æ¥æ”¶çš„æ•°æ®èµ‹å€¼ç»™v
v := <-ch

// Comma-oké£æ ¼å†™æ³•
v, ok := <-ch

```


éé˜»å¡å¼ä»£ç ï¼š


```go
select {
case <-ch:
    ...
default:
    ...
}

```


è¿™é‡Œçš„selectåªé’ˆå¯¹ä½†ä¸ª`channel`çš„æ“ä½œï¼Œå¤šè·¯selectåˆæœ‰æ‰€ä¸åŒ


## å¤šè·¯select


å¤šè·¯selectæŒ‡çš„å­˜åœ¨ä¸¤ä¸ªæˆ–æ›´å¤šçš„caseåˆ†æ”¯ï¼Œæ¯ä¸ªåˆ†æ”¯å¯ä»¥æ˜¯ä¸€ä¸ª`channel`çš„`send`å’Œ`recv`æ“ä½œ


golangçš„selectè¯­å¥é‡‡ç”¨çš„æ˜¯å¤šè·¯å¤ç”¨çš„æ€æƒ³ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸ºäº†è¾¾åˆ°é€šè¿‡ä¸€ä¸ªåç¨‹åŒæ—¶å¤„ç†å¤šä¸ªIOè¯·æ±‚ï¼ˆChannelè¯»å†™äº‹ä»¶ï¼‰


![](https://whitea.dpdns.org/api?block_id=28493dc3-968c-8067-b085-fe51f91254af)


å¤šè·¯selectä¼šè¢«golangç¼–è¯‘å™¨è½¬åŒ–ä¸ºå¯¹`runtime.selectgo()`çš„å‡½æ•°è°ƒç”¨ï¼Œç”±äºè¯¥å‡½æ•°æºç æœ‰å››ç™¾å¤šè¡Œï¼Œé‚£æˆ‘ä»¬å…ˆä»å‡½æ•°çš„å…¥å‚å’Œå‡ºå‚çœ‹å§


```go
// selectgo implements the select statement.
//
// cas0 points to an array of type [ncases]scase, and order0 points to
// an array of type [2*ncases]uint16 where ncases must be <= 65536.
// Both reside on the goroutine's stack (regardless of any escaping in
// selectgo).
//
// For race detector builds, pc0 points to an array of type
// [ncases]uintptr (also on the stack); for other builds, it's set to
// nil.
//
// selectgo returns the index of the chosen scase, which matches the
// ordinal position of its respective select{recv,send,default} call.
// Also, if the chosen scase was a receive operation, it reports whether
// a value was received.
func selectgo(cas0 *scase, order0 *uint16, pc0 *uintptr, nsends, nrecvs int, block bool) (int, bool)

```


`cas0 *scase`æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨`select`çš„`case`åˆ†æ”¯


`order0 *uint16`æŒ‡å‘çš„æ˜¯ä¸€ä¸ªç±»å‹ä¸º`uint16`çš„æ•°ç»„ï¼Œå…¶é•¿åº¦æ˜¯åˆ†æ”¯æ•°é‡çš„2å€ï¼Œå‰é¢ä¸€åŠç”¨äºå¯¹æ¯ä¸ª`channel`çš„ä¹±åºè½®è¯¢ï¼ˆä¿è¯å…¬å¹³æ€§ï¼‰ï¼Œåé¢ä¸€åŠç”¨äºæœ‰åºçš„å¯¹æ¯ä¸ª`channel`åŠ é”ï¼ˆåˆç†çš„åŠ é”é¡ºåºæ‰èƒ½é¿å…æ­»é”ï¼‰


`pc0 *uintptr`ä¸golangçš„raceæ£€æµ‹ç›¸å…³ [race-detector](https://go.dev/blog/race-detector)ï¼Œè¿™é‡Œä¸å±•å¼€è¯´


`nsends, nrecvs int`åˆ†åˆ«è®°å½•ç”¨äº`send`å’Œ`recv`æ“ä½œçš„åˆ†æ”¯åˆ†åˆ«æœ‰å¤šå°‘ä¸ª


`block bool`è¡¨ç¤ºæ˜¯å¦é˜»å¡ï¼Œå³æœ‰`default`ä¸º`false`ï¼Œåä¹‹ä¸º`true`


æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹


```go
func selectgo(cas0 *scase, order0 *uint16, pc0 *uintptr, nsends, nrecvs int, block bool) (int, bool) {
  ......
  // ä¸ºäº†å°†scaseåˆ†é…åˆ°æ ˆä¸Šï¼Œè¿™é‡Œç›´æ¥ç»™cas1åˆ†é…äº†64KBå¤§å°çš„æ•°ç»„ï¼ŒåŒç†ï¼Œ ç»™order1åˆ†é…äº†128KBå¤§å°çš„æ•°ç»„
  cas1 := (*[1 << 16]scase)(unsafe.Pointer(cas0))
  order1 := (*[1 << 17]uint16)(unsafe.Pointer(order0))

  // ncasesä¸ªæ•°æ˜¯å‘é€chanä¸ªæ•°nsendsåŠ ä¸Šæ¥æ”¶chanä¸ªæ•°nrecvs
  ncases := nsends + nrecvs
  // scasesåˆ‡ç‰‡æ˜¯ä¸Šé¢åˆ†é…cas1æ•°ç»„çš„å‰ncasesä¸ªå…ƒç´ 
  scases := cas1[:ncases:ncases]
  // é¡ºåºåˆ—è¡¨pollorderæ˜¯order1æ•°ç»„çš„å‰ncasesä¸ªå…ƒç´ 
  pollorder := order1[:ncases:ncases]
  // åŠ é”åˆ—è¡¨lockorderæ˜¯order1æ•°ç»„çš„ç¬¬äºŒæ‰¹ncaseä¸ªå…ƒç´ 
  // æ‰€ä»¥è¯´order0æŒ‡å‘çš„æ•°ç»„æ˜¯caseæ•°é‡çš„ä¸¤å€ï¼Œåˆ†æˆå‰ä¸€åŠå’Œåä¸€åŠä½¿ç”¨
  lockorder := order1[ncases:][:ncases:ncases]
  ......

  // ç”Ÿæˆæ’åˆ—é¡ºåºï¼ˆé¿å… channel çš„é¥¥é¥¿é—®é¢˜ï¼Œä¿è¯å…¬å¹³æ€§ï¼‰
  norder := 0
  for i := range scases {
    cas := &scases[i]

    // å¤„ç†caseä¸­channelä¸ºç©ºçš„æƒ…å†µ
    if cas.c == nil {
      cas.elem = nil // å°†elemç½®ç©ºï¼Œä¾¿äºGC
      continue
    }
    // é€šè¿‡fastrandnå‡½æ•°å¼•å…¥éšæœºæ€§ï¼Œç¡®å®špollorderåˆ—è¡¨ä¸­caseçš„éšæœºé¡ºåºç´¢å¼•
    j := fastrandn(uint32(norder + 1))
    pollorder[norder] = pollorder[j]
    pollorder[j] = uint16(i)
    norder++
  }
  pollorder = pollorder[:norder]
  lockorder = lockorder[:norder]

  // æ ¹æ®chanåœ°å€ç¡®å®šlockorderåŠ é”æ’åºåˆ—è¡¨çš„é¡ºåº
  // é€šè¿‡ç®€å•çš„å †æ’åºï¼Œä»¥nlognæ—¶é—´å¤æ‚åº¦å®Œæˆæ’åº
  for i := range lockorder {
    j := i
    // Start with the pollorder to permute cases on the same channel.
    c := scases[pollorder[i]].c
    for j > 0 && scases[lockorder[(j-1)/2]].c.sortkey() < c.sortkey() {
      k := (j - 1) / 2
      lockorder[j] = lockorder[k]
      j = k
    }
    lockorder[j] = pollorder[i]
  }
  for i := len(lockorder) - 1; i >= 0; i-- {
    o := lockorder[i]
    c := scases[o].c
    lockorder[i] = lockorder[0]
    j := 0
    for {
      k := j*2 + 1
      if k >= i {
        break
      }
      if k+1 < i && scases[lockorder[k]].c.sortkey() < scases[lockorder[k+1]].c.sortkey() {
        k++
      }
      if c.sortkey() < scases[lockorder[k]].c.sortkey() {
        lockorder[j] = lockorder[k]
        j = k
        continue
      }
      break
    }
    lockorder[j] = o
  }
        ......
}

```


åŠ é”å’Œè§£é”è°ƒç”¨çš„æ˜¯`runtime.sellock()`å‡½æ•°å’Œ`runtime.selunlock()`å‡½æ•°ã€‚ä»ä¸‹é¢çš„ä»£ç é€»è¾‘ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯æŒ‰`lockorder`é¡ºåºå¯¹`channel`åŠ é”ï¼Œä»¥åŠæŒ‰`lockorder`é€†åºé‡Šæ”¾é”ã€‚


```go
func sellock(scases []scase, lockorder []uint16) {
  var c *hchan
  for _, o := range lockorder {
    c0 := scases[o].c
    if c0 != c {
      c = c0
      lock(&c.lock)
    }
  }
}

func selunlock(scases []scase, lockorder []uint16) {
  for i := len(lockorder) - 1; i >= 0; i-- {
    c := scases[lockorder[i]].c
    if i > 0 && c == scases[lockorder[i-1]].c {
      continue
    }
    unlock(&c.lock)
  }
}

```


æ¥ä¸‹æ¥å°±æ˜¯`selectgo`çš„ä¸»é€»è¾‘å•¦ï¼ˆå¥½é•¿ğŸ˜­ï¼‰


```go
func selectgo(cas0 *scase, order0 *uint16, pc0 *uintptr, nsends, nrecvs int, block bool) (int, bool) {
        ......
  sellock(scases, lockorder)
        ......
  // é˜¶æ®µä¸€: æŸ¥æ‰¾å¯ä»¥å¤„ç†çš„channel
  var casi int
  var cas *scase
  var caseSuccess bool
  var caseReleaseTime int64 = -1
  var recvOK bool
  for _, casei := range pollorder {
    casi = int(casei)      // caseçš„ç´¢å¼•
    cas = &scases[casi]    // å½“å‰çš„case
    c = cas.c

    if casi >= nsends { // å¤„ç†æ¥æ”¶channelçš„case
      sg = c.sendq.dequeue()
      // å¦‚æœå½“å‰channelçš„sendqä¸Šæœ‰ç­‰å¾…çš„goroutineï¼Œå°±ä¼šè·³åˆ° recvæ ‡ç­¾å¹¶ä»ç¼“å†²åŒºè¯»å–æ•°æ®åå°†ç­‰å¾…goroutineä¸­çš„æ•°æ®æ”¾å…¥åˆ°ç¼“å†²åŒºä¸­ç›¸åŒçš„ä½ç½®ï¼›
      if sg != nil {
        goto recv
      }
      if c.qcount > 0 { //å¦‚æœå½“å‰channelçš„ç¼“å†²åŒºä¸ä¸ºç©ºï¼Œå°±ä¼šè·³åˆ°bufrecvæ ‡ç­¾å¤„ä»ç¼“å†²åŒºè·å–æ•°æ®ï¼›
        goto bufrecv
      }
      if c.closed != 0 {  //å¦‚æœå½“å‰channelå·²ç»è¢«å…³é—­ï¼Œå°±ä¼šè·³åˆ°rcloseåšä¸€äº›æ¸…é™¤çš„æ”¶å°¾å·¥ä½œï¼›
        goto rclose
      }
    } else {                      // å¤„ç†å‘é€channelçš„case
      ......
      if c.closed != 0 { // å¦‚æœå½“å‰channelå·²ç»è¢«å…³é—­å°±ä¼šç›´æ¥è·³åˆ°scloseæ ‡ç­¾ï¼Œè§¦å‘ panic å°è¯•ä¸­æ­¢ç¨‹åºï¼›
        goto sclose
      }
      sg = c.recvq.dequeue()
      if sg != nil {  // å¦‚æœå½“å‰channelçš„recvqä¸Šæœ‰ç­‰å¾…çš„goroutineï¼Œå°±ä¼šè·³åˆ° sendæ ‡ç­¾å‘channelå‘é€æ•°æ®ï¼›
        goto send
      }
      if c.qcount < c.dataqsiz { // å¦‚æœå½“å‰channelçš„ç¼“å†²åŒºå­˜åœ¨ç©ºé—²ä½ç½®ï¼Œå°±ä¼šå°†å¾…å‘é€çš„æ•°æ®å­˜å…¥ç¼“å†²åŒºï¼›
        goto bufsend
      }
    }
  }
  if !block {  // å¦‚æœæ˜¯éé˜»å¡ï¼Œå³åŒ…å«defaultåˆ†æ”¯ï¼Œä¼šè§£é”æ‰€æœ‰ Channel å¹¶è¿”å›
       selunlock(scases, lockorder)
       casi = -1
       goto retc
  }

  // é˜¶æ®µ2: å°†å½“å‰goroutineæ ¹æ®éœ€è¦æŒ‚åœ¨chançš„sendqå’Œrecvqä¸Š
  gp = getg()
  if gp.waiting != nil {
    throw("gp.waiting != nil")
  }
  nextp = &gp.waiting
  for _, casei := range lockorder {
    casi = int(casei)
    cas = &scases[casi]
    c = cas.c
    // è·å–sudogï¼Œå°†å½“å‰goroutineç»‘å®šåˆ°sudogä¸Š
    sg := acquireSudog()
    sg.g = gp
    sg.isSelect = true
    sg.elem = cas.elem
    sg.releasetime = 0
    if t0 != 0 {
      sg.releasetime = -1
    }
    sg.c = c
    *nextp = sg
    nextp = &sg.waitlink
    // åŠ å…¥ç›¸åº”ç­‰å¾…é˜Ÿåˆ—
    if casi < nsends {
      c.sendq.enqueue(sg)
    } else {
      c.recvq.enqueue(sg)
    }
  }
  		......
  // è¢«å”¤é†’åä¼šæ ¹æ® param æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ç”± close æ“ä½œå”¤é†’çš„ï¼Œæ‰€ä»¥å…ˆç½®ä¸º nil
  gp.param = nil
  		......
  // æŒ‚èµ·å½“å‰goroutine
  gopark(selparkcommit, nil, waitReasonSelect, traceEvGoBlockSelect, 1)

  // åŠ é”æ‰€æœ‰çš„channel
  sellock(scases, lockorder)

  gp.selectDone = 0
  // param å­˜æ”¾å”¤é†’ goroutine çš„ sudogï¼Œå¦‚æœæ˜¯å…³é—­æ“ä½œå”¤é†’çš„ï¼Œé‚£ä¹ˆå°±ä¸º nil
  sg = (*sudog)(gp.param)
  gp.param = nil

  casi = -1
  cas = nil
  caseSuccess = false
  // å½“å‰goroutine çš„ waiting é“¾è¡¨æŒ‰ç…§lockorderé¡ºåºå­˜æ”¾ç€caseçš„sudog
  sglist = gp.waiting
  // åœ¨ä» gp.waiting å–æ¶ˆcaseçš„sudogé“¾æ¥ä¹‹å‰æ¸…é™¤æ‰€æœ‰å…ƒç´ ï¼Œä¾¿äºGC
  for sg1 := gp.waiting; sg1 != nil; sg1 = sg1.waitlink {
    sg1.isSelect = false
    sg1.elem = nil
    sg1.c = nil
  }
   // æ¸…æ¥šå½“å‰goroutineçš„waitingé“¾è¡¨ï¼Œå› ä¸ºè¢«sgä»£è¡¨çš„åç¨‹å”¤é†’äº†
  gp.waiting = nil

  for _, casei := range lockorder {
    k = &scases[casei]
    // å¦‚æœç›¸ç­‰è¯´æ˜ï¼Œgoroutineæ˜¯è¢«å½“å‰caseçš„channelæ”¶å‘æ“ä½œå”¤é†’çš„
    if sg == sglist {
      // sgå”¤é†’äº†å½“å‰goroutine, åˆ™å½“å‰Gå·²ç»ä»sgçš„é˜Ÿåˆ—ä¸­å‡ºé˜Ÿï¼Œè¿™é‡Œä¸éœ€è¦å†æ¬¡å‡ºé˜Ÿ
      casi = int(casei)
      cas = k
      caseSuccess = sglist.success
      if sglist.releasetime > 0 {
        caseReleaseTime = sglist.releasetime
      }
    } else {
      // ä¸æ˜¯æ­¤caseå”¤é†’å½“å‰goroutine, å°†goroutineä»æ­¤caseçš„å‘é€é˜Ÿåˆ—æˆ–æ¥æ”¶é˜Ÿåˆ—å‡ºé˜Ÿ
      c = k.c
      if int(casei) < nsends {
        c.sendq.dequeueSudoG(sglist)
      } else {
        c.recvq.dequeueSudoG(sglist)
      }
    }
    // é‡Šæ”¾å½“å‰caseçš„sudogï¼Œç„¶åå¤„ç†ä¸‹ä¸€ä¸ªcaseçš„sudog
    sgnext = sglist.waitlink
    sglist.waitlink = nil
    releaseSudog(sglist)
    sglist = sgnext
  }
}

// æœ€åçš„ä»£ç æ˜¯å¾ªç¯ç¬¬ä¸€é˜¶æ®µç”¨åˆ°çš„è·³è½¬æ ‡ç­¾ä»£ç æ®µ
bufrecv:
  ......
  recvOK = true
  qp = chanbuf(c, c.recvx)
  if cas.elem != nil {
    typedmemmove(c.elemtype, cas.elem, qp)
  }
  typedmemclr(c.elemtype, qp)
  c.recvx++
  if c.recvx == c.dataqsiz {
    c.recvx = 0
  }
  c.qcount--
  selunlock(scases, lockorder)
  goto retc

bufsend:
  ......
  typedmemmove(c.elemtype, chanbuf(c, c.sendx), cas.elem)
  c.sendx++
  if c.sendx == c.dataqsiz {
    c.sendx = 0
  }
  c.qcount++
  selunlock(scases, lockorder)
  goto retc

recv:
  // å¯ä»¥ç›´æ¥ä»ä¼‘çœ çš„goroutineè·å–æ•°æ®
  recv(c, sg, cas.elem, func() { selunlock(scases, lockorder) }, 2)
  ......
  recvOK = true
  goto retc

rclose:
  //ä»ä¸€ä¸ªå…³é—­ channel ä¸­æ¥æ”¶æ•°æ®ä¼šç›´æ¥æ¸…é™¤ Channel ä¸­çš„ç›¸å…³å†…å®¹ï¼›
  selunlock(scases, lockorder)
  recvOK = false
  if cas.elem != nil {
    typedmemclr(c.elemtype, cas.elem)
  }
  ......
  goto retc

send:
  ......
  // å¯ä»¥ç›´æ¥ä»ä¼‘çœ çš„goroutineè·å–æ•°æ®
  send(c, sg, cas.elem, func() { selunlock(scases, lockorder) }, 2)
  if debugSelect {
    print("syncsend: cas0=", cas0, " c=", c, "\\n")
  }
  goto retc

retc:
  // é€€å‡ºselectgo()å‡½æ•°
  if caseReleaseTime > 0 {
    blockevent(caseReleaseTime-t0, 1)
  }
  return casi, recvOK

sclose:
  // å‘ä¸€ä¸ªå…³é—­çš„ channel å‘é€æ•°æ®å°±ä¼šç›´æ¥ panic é€ æˆç¨‹åºå´©æºƒï¼›
  selunlock(scases, lockorder)
  panic(plainError("send on closed channel"))


```


æ€»ç»“ä¸€ä¸‹


`selectgo`å‡½æ•°æ‰§è¡Œæ—¶ä¼šå…ˆæŒ‰ç…§æœ‰åºçš„åŠ é”é¡ºåºå¯¹æ‰€æœ‰çš„`channel`è¿›è¡ŒåŠ é”


ç„¶åæŒ‰ç…§ä¹±åºçš„è½®è¯¢é¡ºåºæ£€æŸ¥æ‰€æœ‰`channel`çš„ç­‰å¾…é˜Ÿåˆ—å’Œç¼“å†²åŒºï¼Œå‡å¦‚æ£€æŸ¥åˆ°æŸä¸ª`channel`æœ‰æ•°æ®å¯æ“ä½œï¼Œå°±ä¼šç›´æ¥æ‹·è´æ•°æ®è¿›å…¥ç›¸åº”çš„`case`åˆ†æ”¯


å¦‚æœæ‰€æœ‰çš„`channel`éƒ½ä¸å¯æ“ä½œï¼Œå°±æŠŠå½“å‰çš„åç¨‹æ·»åŠ åˆ°æ‰€æœ‰`channel`çš„`sendq`æˆ–`recvq`ä¸­


æ¥ç€è¯¥åç¨‹ä¼šæŒ‚èµ·ï¼Œå¹¶è§£é”æ‰€æœ‰çš„`channel`


åŠ å…¥ç°åœ¨æŸä¸ª`channel`æœ‰æ•°æ®å¯æ“ä½œäº†ï¼Œå°±ä¼šå”¤é†’è¯¥åç¨‹è¿›å…¥`case`åˆ†æ”¯


å®Œæˆå¯¹åº”åˆ†æ”¯çš„æ“ä½œä¹‹åï¼Œä¼šå†æ¬¡æŒ‰ç…§åŠ é”é¡ºåºå¯¹æ‰€æœ‰`channel`è¿›è¡ŒåŠ é”ï¼Œç„¶åä»æ‰€æœ‰`sendq`æˆ–`recvq`ä¸­å°†è‡ªå·±ç§»é™¤


æœ€åå…¨éƒ¨è§£é”åè¿”å›


![](https://whitea.dpdns.org/api?block_id=28493dc3-968c-804f-b764-cef983b5f2fb)


## ç¼–è¯‘å™¨è¿˜å¯¹selectåšäº†å“ªäº›å¤„ç†


è¿™é‡Œä¸»è¦è¿˜æƒ³æåˆ°çš„æ˜¯`src/cmd/compile/internal/walk/select.go`ä¸­çš„`walkSelectCases()`


è¯¥å‡½æ•°æ˜¯å¯¹`select`ä¸åŒ`case`åˆ†æ”¯æ¡ä»¶çš„å¤„ç†ï¼Œä¸åŒçš„æƒ…å†µä¼šè°ƒç”¨ä¸åŒçš„è¿è¡Œæ—¶å‡½æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º


![](https://whitea.dpdns.org/api?block_id=28493dc3-968c-8028-b2f0-e959f9b4b204)


å…·ä½“å…³äº`walkSelectCases()`çš„æºç å°±æš‚æ—¶ä¸åœ¨è¿™é‡Œå±•å¼€å•¦


> ä½œä¸ºä¸€åå¤§äºŒå°ç™½Gopherï¼Œæ–‡ç« å­˜åœ¨æœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥è”ç³»æˆ‘ï¼Œå½“ç„¶ä¹Ÿæ¬¢è¿ä¸æˆ‘äº¤æµæŠ€æœ¯ç›¸å…³çš„é—®é¢˜ï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ğŸ¤—

